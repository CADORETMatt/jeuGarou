<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralala - Jeu Garou Mortel</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        :root {
            --background-color: #222;
            --background-secondary: #000;
            --text-color: #d9bfff;
            --primary-color: #470684;
            --accent-color: #FF06B5;
            --box-shadow-color: #FF06B5;
            --border-color: #333;
            --input-bg: #1c1c1c;
            --button-hover-bg: #555;
            --sidebar-bg: #1b1b1b;
            --log-bg: #000;
            --footer-color: #aaa;
            --buzz-inactive-opacity: 0.4;
            --buzz-glow: rgba(255, 0, 0, 0.6);
            --border-radius: 12px;
            --padding: 16px;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: radial-gradient(circle at top, var(--background-color) 0%, var(--background-secondary) 60%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #buzz-next {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at top, #44ff88, #117733);
            box-shadow: 0 0 25px rgba(0, 255, 128, 0.6);
            color: black;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: var(--sidebar-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            z-index: 10;
            overflow-y: auto;
        }

        #sidebar h2 {
            color: var(--text-color);
        }

        #sidebar button {
            padding: 10px;
            background: var(--primary-color);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
            cursor: pointer;
            border-radius: 8px;
            text-align: left;
        }

        #sidebar button:hover {
            color: var(--accent-color);
            box-shadow: 0 0 10px var(--box-shadow-color);
        }

        #sidebar button.active {
            background: var(--button-hover-bg);
        }

        #player-params {
            margin-top: 20px;
            padding: 10px;
            background: var(--primary-color);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            display: none;
        }

        #player-params label {
            display: block;
            margin-bottom: 10px;
        }

        #player-params input,
        #player-params select {
            width: 100%;
            padding: 5px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        #player-params button {
            margin-top: 10px;
        }

        #main {
            position: relative;
            margin-left: 320px;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        #display {
            flex: 1;
            background: var(--log-bg);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        #display p {
            margin-bottom: 10px;
            display: none;
            /* Par d√©faut cach√©, visible via JS */
        }

        #display p.visible {
            display: block;
        }

        #input-zone {
            display: flex;
            padding: 10px;
            background: #111;
            border-top: 1px solid var(--border-color);
        }

        #message-input {
            flex: 1;
            padding: 10px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-right: 10px;
        }

        #send-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
            cursor: pointer;
            border-radius: 8px;
        }

        #send-btn:hover {
            color: var(--accent-color);
            box-shadow: 0 0 10px var(--box-shadow-color);
        }

        #buzz-zone {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            padding: 10px;
        }

        #buzz {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle at top, #ff4444, #990000);
            box-shadow: 0 0 40px var(--buzz-glow);
            color: white;
            font-weight: bold;
            cursor: pointer;
            opacity: var(--buzz-inactive-opacity);
            border: none;
        }

        #buzz.active {
            opacity: 1;
            animation: pulse 1.2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
            }

            50% {
                box-shadow: 0 0 55px rgba(255, 0, 0, 0.9);
            }

            100% {
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
            }
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.75rem;
            color: var(--footer-color);
            background: #111;
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                flex-direction: row;
                justify-content: space-around;
                overflow-y: visible;
            }

            #main {
                margin-left: 0;
                margin-top: 120px;
            }

            #player-params {
                margin-top: 10px;
            }
        }

        #player-buttons {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        #player-buttons button {
            flex: 1;
            text-align: center;
        }

        @media (min-width: 900px) {
            #player-presentation {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            #player-params label {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
        }

        #player-presentation p {
            background: #111;
            padding: 8px;
            border-radius: 6px;
        }

        #mj-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 420px;
            max-height: 45vh;
            overflow: auto;

            background: #0b0b0b;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;

            font-size: 0.75rem;
            white-space: pre-wrap;
            display: none;
            z-index: 5;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h2>Tableau de bord</h2>
        <div id="player-buttons">
            <button id="btn-j1">J1</button>
            <button id="btn-j2">J2</button>
            <button id="btn-j3">J3</button>
        </div>
        <div id="player-presentation"></div>
        <div id="player-params">
            <h3>Param√®tres du Joueur</h3>
            <label>Nom: <input type="text" id="param-name"></label>
            <label>Role: <input type="text" id="param-role" readonly></label>
            <label>Personnage: <input type="text" id="param-perso"></label>
            <label>Type:
                <select id="param-type">
                    <option value="Humain">Humain</option>
                    <option value="Gpt">Gpt</option>
                </select>
            </label>
            <label>Sc√®ne: <input type="text" id="param-scene"></label>
            <label>Vivant: <input type="checkbox" id="param-vivant"></label>
            <button id="save-params">Sauvegarder</button>
        </div>
    </div>

    <div id="main">
        <h1>Tralala - Jeu Garou Mortel</h1>
        <div id="game-banner">
            <span id="game-status">üïØÔ∏è Le jeu est en cours</span>

            <button id="toggle-player">Vue : J1</button>
            <button id="toggle-mj">Mode : Joueur</button>

            <div id="mj-panel" style="display:none;">
                <h3>üé≠ Mode Ma√Ætre du Jeu</h3>
                <textarea style="width: 300px;" id="adn-editor" rows="8"></textarea>
                <button id="apply-adn">Appliquer ADN</button>
            </div>
        </div>

        <div id="room-info"></div>
        <!--A FAIRE : Mettre titre √† gauche et Bouton MJ/Joueur √† droite dans m√™me div-->

        <div id="display"></div>
        <div id="buzz-zone">
            <button id="buzz">BUZZ</button>
            <p id="buzz-info">Le buzz est inactif.</p>
            <button id="buzz-next">NEXT</button>
        </div>
        <div id="input-zone">
            <input type="text" id="message-input" placeholder="√âcris ton message...">
            <button id="send-btn">Envoyer</button>
        </div>
        <div>
        </div>
    </div>

    <footer>
        Jeu de r√¥le exp√©rimental par MattMarket Digitals.
        <button id="abandon-btn">Abandonner la partie</button>
        <button id="save-partie">üíæ Sauvegarder la partie</button>
        <button id="load-partie">üìÇ Ouvrir une partie</button>
        <input type="file" id="load-file" accept="application/json" style="display:none">
    </footer>

    <script>
        // OpenAI API Key
        const OPENAI_API_KEY = "VOTRE_CLE_API_ICI";

        // Objet Partie contenant ADN et historique
        let partie = {
            adn: {
                Lieu: "√âmission TV ¬´ Tralala ¬ª",
                Buzz: "inactif",
                SallePublic: "Pupitre TV",
                J1: { sallePerso: 1, scene: "Epreuve", nom: "Toi", role: "Justicier", perso: "Animateur", vivant: true, type: "Humain" },
                J2: { sallePerso: 2, scene: "Loge", nom: "Robert", role: "Acolyte", perso: "Candidat", vivant: true, type: "Gpt" },
                J3: { sallePerso: 3, scene: "Coulisses", nom: "Michel", role: "Meurtrier", perso: "Producteur", vivant: true, type: "Gpt" },
                currentSalle: "SallePublic",
                buzzActive: false
            },
            history: [] // {sender: 'salleKey', message: 'texte', target: 'salleKey'}
        };

        const display = document.getElementById('display');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const buzz = document.getElementById('buzz');
        const buzzInfo = document.getElementById('buzz-info');
        const playerParams = document.getElementById('player-params');
        const paramName = document.getElementById('param-name');
        const paramRole = document.getElementById('param-role');
        const paramPerso = document.getElementById('param-perso');
        const paramType = document.getElementById('param-type');
        const paramScene = document.getElementById('param-scene');
        const paramVivant = document.getElementById('param-vivant');
        const saveParams = document.getElementById('save-params');

        const salleOrder = ['SallePublic', 'J1', 'J2', 'J3'];
        let mode = 'joueur'; // ou 'mj'
        let currentSalle = 'SallePublic'; // Par d√©faut, salle du joueur
        ///////View des joueur////////////////
        const viewUser = ['MJ', 'joueur'];
        const playerKeys = ['J1', 'J2', 'J3'];
        let ViewedPlayer = playerKeys[0]; // J1 par d√©faut (source de v√©rit√© : playerKeys)
        const togglePlayerBtn = document.getElementById('toggle-player');
        togglePlayerBtn.addEventListener('click', () => {
            const index = playerKeys.indexOf(ViewedPlayer);
            const newIndex = (index + 1) % playerKeys.length;
            ViewedPlayer = playerKeys[newIndex];
            togglePlayerBtn.textContent = `Vue : ${ViewedPlayer}`;
            updateViewPlayer();
        });
        //////////// Btn MJ  ////////////////////////
        const toggleMJBtn = document.getElementById('toggle-mj');
        const mjPanel = document.getElementById('mj-panel');
        const adnEditor = document.getElementById('adn-editor');
        toggleMJBtn.addEventListener('click', () => {
            if (mode === 'joueur') {
                mode = 'mj';
                toggleMJBtn.textContent = "Mode: MJ";
                mjPanel.style.display = 'block';
                adnEditor.value = JSON.stringify(partie.adn, null, 2);
            } else {
                mode = 'joueur';
                toggleMJBtn.textContent = "Mode: Joueur";
                mjPanel.style.display = 'none';

            }

            applyPermissions();
        });
        //////////////  Inject ADN /////////////////
        /*function applyAdnChange(newAdn, origin = 'MJ') {
            partie.adn = newAdn;

            partie.history.push({
                sender: 'System',
                message:
                    origin === 'MJ'
                        ? 'üîÑ L‚ÄôADN du sc√©nario a √©t√© modifi√© par le MJ.'
                        : `‚úèÔ∏è ${partie.adn[origin]?.nom ?? origin} a modifi√© ses param√®tres.`,
                target: null
            });
            updateCardPlayer(); showMessages();
        }*/

        function applyAdnChange(origin = 'MJ') {
            try {
                const parsedAdn = JSON.parse(adnEditor.value);
                partie.adn = parsedAdn;

                partie.history.push({
                    sender: 'System',
                    message:
                        origin === 'MJ'
                            ? 'üîÑ L‚ÄôADN du sc√©nario a √©t√© modifi√© par le MJ.'
                            : `‚úèÔ∏è ${partie.adn[origin]?.nom ?? origin} a modifi√© ses param√®tres.`,
                    target: null
                });
                updateCardPlayer(); showMessages();
            } catch (e) {
                alert("ADN invalide (JSON incorrect)");
            }
        }

        document.getElementById('apply-adn').addEventListener('click', () => {
            const origin = mode === 'mj' ? 'MJ' : ViewedPlayer;
            applyAdnChange(origin);
        });
        ////////////Next Salle /////////////////
        const buzzNext = document.getElementById('buzz-next');

        buzzNext.addEventListener('click', (e) => {
            if (e.shiftKey) {
                //toggleSalle();
            } else {
                nextSalle(); updateCardPlayer();
            }
        });
        /////////////////Sauvegarder////////////////////////
        document.getElementById('save-partie').addEventListener('click', () => {
            const data = JSON.stringify(partie, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'partie.json';
            a.click();

            URL.revokeObjectURL(url);
        });
        ///////////OUVRIR //////////////////////////////
        document.getElementById('load-partie').addEventListener('click', () => {
            document.getElementById('load-file').click();
        });

        document.getElementById('load-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const loaded = JSON.parse(reader.result);
                    partie = loaded;

                    updateCardPlayer();
                    updateSalle();
                    updateMJAdnView();
                    showMessages();
                } catch {
                    alert('Fichier JSON invalide');
                }
            };
            reader.readAsText(file);
        });
        /////////////////////////////        // Fonction pour afficher les messages
        function showMessages() {
            display.innerHTML = '';
            partie.history.forEach(msg => {
                const isRelevant = (msg.sender === 'J1' && msg.target === currentSalle) ||
                    (msg.sender === currentSalle && msg.target === 'J1') ||
                    ((currentSalle === 'J1' || currentSalle === 'SallePublic') && !msg.target); // Publique

                if (isRelevant) {
                    const p = document.createElement('p');
                    const senderName =
                        msg.sender === 'System'
                            ? 'üïØÔ∏è Syst√®me'
                            : partie.adn[msg.sender]?.nom ?? msg.sender;
                    p.textContent = `${senderName}: ${msg.message}`;
                    p.classList.add('visible'); // Toujours visible si relevant
                    if (partie.adn[currentSalle] && typeof partie.adn[currentSalle] === 'object' && !partie.adn[currentSalle].vivant) {
                        p.style.display = 'none'; // Invisible si absent
                    }
                    display.appendChild(p);
                }
            });
            display.scrollTop = display.scrollHeight;
        }

        // Appel √† l'API OpenAI
        async function askGPT(systemPrompt, userPrompt) {
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: 0.9
                })
            });
            const data = await res.json();
            return data.choices[0].message.content;
        }

        // R√©ponse d'un joueur IA
        async function getIAResponse(salleKey) {
            const player = partie.adn[salleKey];
            if (player.type !== 'Gpt' || !player.vivant) return null;

            const systemPrompt = `
Tu es ${player.nom} (${player.perso}), r√¥le secret: ${player.role}.
Tu joues UNIQUEMENT ton personnage.
Tu n'√©cris QUE tes dialogues ou actions (1-2 phrases max).
Si tu es le meurtrier, tu te fais passer pour bienveillant.
Respecte l'ADN comme carnet de bord.
`;

            const userPrompt = `
ADN{
${JSON.stringify(partie.adn, null, 2)}
}

R√©agis √† la derni√®re interaction dans la sc√®ne avec Toi.
`;

            return await askGPT(systemPrompt, userPrompt);
        }

        // Activation du buzz
        function activateBuzz() {
            partie.adn.Buzz = "actif";
            partie.adn.buzzActive = true;
            buzz.classList.add('active');
            buzzInfo.textContent = "Le buzz est ACTIF. Un choix peut tuer.";
        }

        // Gestion des boutons joueurs (limiter la s√©lection aux boutons joueurs)
        const playerButtons = document.querySelectorAll('#player-buttons button');
        playerButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                playerButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const raw = btn.id.replace('btn-', '');
                ViewedPlayer = raw.charAt(0).toUpperCase() + raw.slice(1);
                loadPlayerParams();
            });
        });
        // Charger les params du joueur
        function loadPlayerParams(playerKey = ViewedPlayer) {
            const player = partie.adn[playerKey];
            if (!player || typeof player !== 'object') return;

            paramName.value = player.nom;
            paramRole.value = player.role;
            paramPerso.value = player.perso;
            paramType.value = player.type;
            paramScene.value = player.scene;
            paramVivant.checked = player.vivant;
        }

        // Sauvegarder les params
        saveParams.addEventListener('click', () => {
            const player = partie.adn[ViewedPlayer];
            player.nom = paramName.value;
            player.perso = paramPerso.value;
            player.type = paramType.value;
            player.scene = paramScene.value;
            player.vivant = paramVivant.checked;
            // Mise √† jour des boutons si nom change
            const btnEl = document.getElementById(`btn-${ViewedPlayer.toLowerCase()}`);
            if (btnEl) btnEl.textContent = `Joueur ${ViewedPlayer.replace('J', '')} (#${player.nom})`;

            // Enregistrer modification dans l'historique et mettre √† jour l'UI
            partie.history.push({
                sender: 'System',
                message: `‚úèÔ∏è ${partie.adn[ViewedPlayer]?.nom ?? ViewedPlayer} a modifi√© ses param√®tres.`,
                target: null
            });
            updateCardPlayer();
            showMessages();
        });

        // Envoi de message
        sendBtn.addEventListener('click', async () => {
            const message = messageInput.value.trim();
            if (!message) return;

            const target = (currentSalle !== 'J1' && currentSalle !== 'SallePublic') ? currentSalle : null;
            partie.history.push({ sender: 'J1', message, target });
            showMessages();
            messageInput.value = '';

            if (target) {
                // Conversation priv√©e
                const response = await getIAResponse(target);
                if (response) {
                    partie.history.push({ sender: target, message: response, target: 'J1' });
                    showMessages();
                }
            } else {
                // Publique, r√©pondre les autres si GPT et vivants
                for (let salle of ['J2', 'J3']) {
                    const response = await getIAResponse(salle);
                    if (response) {
                        partie.history.push({ sender: salle, message: response, target: null });
                    }
                }
                showMessages();
            }
        });

        // Gestion du buzz
        buzz.addEventListener('click', () => {
            if (!partie.adn.buzzActive) return;
            const msg = "üëâ Tu appuies sur le buzz.";
            partie.history.push({ sender: 'System', message: msg, target: null });
            if (partie.adn.J3.vivant) {
                const killMsg = "üí• PAN ! Michel est d√©masqu√© comme meurtrier.";
                partie.history.push({ sender: 'System', message: killMsg, target: null });
                partie.adn.J3.vivant = false;
            }
            buzz.disabled = true;
            showMessages();
        });

        ///////////Toujours visible Salle/Perso/////////
        function renderPlayerPresentation() {
            const presentation = document.getElementById('player-presentation');

            const players = Object.entries(partie.adn)
                .filter(([k, v]) => v.nom)
                .map(([k, v], i) => `
      <p>
        <strong>J${i + 1} ‚Äì ${v.nom}</strong><br>
        ${v.perso}<br>
        ${v.vivant ? 'ü´Ä Vivant' : '‚ò†Ô∏è Mort'}
      </p>
    `)
                .join('');

            presentation.innerHTML = `<h3>Personnages</h3>${players}`;
        }

        /////////////////// Autorisations   //////////////////////////////
        function applyPermissions() {
            const isMJ = mode === 'mj';

            // √âcriture
            messageInput.disabled = !isMJ && currentSalle !== 'J1' && currentSalle !== 'SallePublic';

            // Buzz = gameplay ‚Üí jamais cach√©
            buzz.style.display = 'block';
            buzzNext.style.display = 'block';
            // Param√®tres joueurs
            playerParams.style.display = isMJ ? 'block' : 'none';
        }
        async function abandonnerPartie(nom) {
            const prompt = `
Voici l'ADN actuel :
${JSON.stringify(partie.adn, null, 2)}

Le joueur ${nom} abandonne.
Red√©finis un nouveau sc√©nario coh√©rent.
Renvoie UNIQUEMENT un nouvel ADN JSON.
`;

            const newAdn = await askGPT(
                "Tu es un ma√Ætre du jeu narratif.",
                prompt
            );

            partie.adn = JSON.parse(newAdn);
            partie.history = [];
            updateCardPlayer();
            showMessages();
        }
        function toggleSalle() {
            // mode = mode === 'joueur' ? 'mj' : 'joueur';
            //buzzNext.textContent = mode === 'mj' ? 'MJ' : 'Joueur';
        }
        ////////////////Gestion Salle ///////////////////////////////////
        function nextSalle() {
            const index = salleOrder.indexOf(currentSalle);
            currentSalle = salleOrder[(index + 1) % salleOrder.length];
            partie.adn.currentSalle = currentSalle;
            if (playerKeys.includes(currentSalle)) {
                ViewedPlayer = currentSalle;
                loadPlayerParams();
                playerButtons.forEach(b => b.classList.remove('active'));
                const el = document.getElementById(`btn-${currentSalle.toLowerCase()}`);
                if (el) el.classList.add('active');
            } else {
                playerButtons.forEach(b => b.classList.remove('active'));
            }
            updateRoomInfo();
            showMessages();
        }

        function updateViewPlayer() {
            loadPlayerParams();
        }
        function updateCardPlayer() {
            // Pr√©sentation visible pour tous
            renderPlayerPresentation();

            const canEdit =
                mode === 'mj' ||
                (mode === 'joueur' && ViewedPlayer === getLocalPlayer());

            if (canEdit) {
                playerParams.style.display = 'block';
                loadPlayerParams(ViewedPlayer);
            } else {
                playerParams.style.display = 'none';
            }

            updateCardPlayerButtons();
        }
        //////////////Pr√©sentation Joueur///////////////////
        function canEditPlayer(playerKey) {
            if (mode === 'mj') return true;
            return playerKey === 'J1'; // joueur local
        }
        function updateCardPlayerButtons() {
            playerKeys.forEach((key, i) => {
                const btn = document.getElementById(`btn-${key.toLowerCase()}`);
                const p = partie.adn[key];
                if (!btn || !p) return;

                btn.textContent = `Joueur ${i + 1} (#${p.nom})`;
            });
        }
        ////////////Joueur local Supabase /////////////////
        function getLocalPlayer() {
            return 'J1'; // pour l‚Äôinstant navigateur = J1
        }
        function updateRoomInfo() {
            const info = document.getElementById('room-info');
            let title = '';
            let scene = '';
            if (currentSalle === 'SallePublic') {
                title = 'Salle Publique';
                scene = partie.adn.SallePublic;
            } else {
                const player = partie.adn[currentSalle];
                title = `${currentSalle} (${player.nom})`;
                scene = player.scene;
            }
            info.innerHTML = `<h2>${title} ‚Äì ${scene}</h2>`;
            const joueurs = Object.entries(partie.adn)
                .filter(([k, v]) => playerKeys.includes(k) && typeof v === 'object' && v.scene === scene && v.vivant)
                .map(([k, v]) => v.nom)
                .join(', ');
            info.innerHTML += `<p>üë• ${joueurs || 'Personne'}</p>`;
        }

        // Initialisation
        function init() {
            const welcome = "üé¨ Bienvenue dans Tralala. Tu es l‚ÄôAnimateur (Justicier). S√©lectionne une salle ou reste en public.";
            partie.history.push({ sender: 'System', message: welcome, target: null });
            showMessages();
            loadPlayerParams();
            updateCardPlayerButtons();
            updateCardPlayer();
            applyPermissions();
            updateRoomInfo();
            setTimeout(activateBuzz, 5000);
        }
        document.getElementById('abandon-btn').addEventListener('click', async () => {
            await abandonnerPartie(partie.adn.J1.nom);
        });
        init();
    </script>
</body>

</html>