<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tralala - Jeu Garou Mortel</title>
    <style>
        :root {
            --background-color: #222;
            --background-secondary: #000;
            --text-color: #d9bfff;
            --primary-color: #470684;
            --accent-color: #FF06B5;
            --box-shadow-color: #FF06B5;
            --border-color: #333;
            --input-bg: #1c1c1c;
            --button-hover-bg: #ff06b5;
            --sidebar-bg: #1b1b1b;
            --log-bg: #000;
            --footer-color: #aaa;
            --buzz-inactive-opacity: 0.4;
            --buzz-glow: rgba(255, 0, 0, 0.6);
            --border-radius: 12px;
            --padding: 16px;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
        }

        button {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: solid 2px var(--accent-color);
            padding: 10px 15px;
            margin: 5px;
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        button:hover {
            background-color: var(--button-hover-bg);
        }
    </style>
</head>

<body>
    <style>
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: block;
            z-index: 100;
        }

        #newPartie-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            display: block;
            z-index: 101;
        }

        .player-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        #cancel-abandon {
            display: none;
        }
    </style>
    <div id="modal-overlay"></div>
    <div id="newPartie-modal">
        <h2>Initier <br>une nouvelle partie ?</h2>
        <button id="load-partie">üìÇ Ouvrir une partie</button>
        <input type="file" id="load-file" accept="application/json" style="display:none">
        <div class="player-line">
            <input type="text" placeholder="Auto ou √©crire lieu, situation" adn-lieu="lieu">
        </div>
        <div class="player-line">
            <input type="text" placeholder="Auto ou √©crire lieu public" adn-public="sallePublic">
        </div>
        <div class="player-line">
            <input type="text" placeholder="Auto ou √©crire nom J1" value="Toi" adn-player="J1">
        </div>
        <div class="player-line">
            <input type="text" placeholder="Auto ou √©crire nom J2" adn-player="J2">
            <label>
                <input type="checkbox" adn-gpt="gpt" checked> ChatBot
            </label>
        </div>

        <div class="player-line">
            <input type="text" placeholder="Auto ou √©crire nom J3" adn-player="J3">
            <label>
                <input type="checkbox" adn-gpt="gpt" checked> ChatBot
            </label>
        </div>
        <div class="modal-actions">
            <button id="start-game">G√©n√©rer Partie</button>
            <button id="cancel-abandon">Annuler</button>
        </div>
    </div>
    <script>/////////////ADN///////////////////////
        const startAdn = {
            lieu: "",
            sallePublic: "",
            players: {
                J1: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Humain" },
                J2: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Gpt" },
                J3: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Gpt" }
            },
            currentSalle: "sallePublic",
            buzzActive: false
        }
        let user1is = 'J1'; // D√©finition globale pour le joueur local

        ////////Overlay//////////////////////////////////////
        const overlay = document.getElementById('modal-overlay');
        const modal = document.getElementById('newPartie-modal');
        ///////////OUVRIR //////////////////////////////
        document.getElementById('load-partie').addEventListener('click', () => {
            document.getElementById('load-file').click();
        });

        document.getElementById('load-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const loaded = JSON.parse(reader.result);
                    partie = loaded;

                    //  updateCardPlayer();
                    //updateSalle();
                    //updateMJAdnView();
                    //showMessages();
                } catch {
                    alert('Charg√© mais fichier JSON peut-√™tre invalide');
                }
            };
            reader.readAsText(file);
            closeNewPartieModal(); // Fermer modal apr√®s load
            updateRoomInfo(); // Actualiser affichage
        });
        function openNewPartieModal() {
            overlay.style.display = 'block';
            modal.style.display = 'block';
            document.getElementById("cancel-abandon").style.display = 'block';
            document.getElementById("cancel-abandon").onclick = function () {
                closeNewPartieModal();
            }
        }
        function closeNewPartieModal() {
            overlay.style.display = 'none';
            modal.style.display = 'none';
            loadPlayerParams(); // Charger les params du joueur apr√®s fermeture modal
            //actualise tableau mj
            //updateCardPlayerButtons();
            //updateCardPlayer();
            //applyPermissions();
            updateRoomInfo();   // Actualiser affichage

        }
        ////////New Partie//////////////////
        document.getElementById('start-game').addEventListener('click', () => {
            const players = [];

            document.querySelectorAll('[adn-player]').forEach(input => {
                const key = input.getAttribute('adn-player');
                const name = input.value || "";
                const isGpt = input.parentElement.querySelector('[adn-gpt]')?.checked;
                players.push({
                    key,
                    nom: name,
                    type: isGpt ? 'gpt' : 'Humain'
                });

                /*const key = input.dataset.player;
    const name = input.value || key;
    const isGpt = document.querySelector(`[adn-gpt]`).checked;*/
                //change partie.adn.lieu
                startAdn.lieu = document.querySelector('[adn-lieu]').value || "";
                //partie.adn.lieu = inputLieu;
                startAdn.sallePublic = document.querySelector('[adn-public]').value || "";
                /*     key,
                     nom: name,
                     lieu: place,
                     sallePublic: public,
                     type: isGpt ? 'gpt' : 'Humain'
                 });
              players: {
                 J1: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Humain" },
                 J2: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Gpt" },
                 J3: { sallePerso: "", scene: "", nom: "", role: "", perso: "", vivant: true, type: "Gpt" }
             }*/
            });

            startNewGame(players);
        });
        function startNewGame(players) {
            const exAdn = partie.adn;
            // üî¥ PLUS TARD : GPT g√©n√®re l‚ÄôADN ici
            // üî¥ PLUS TARD : recherche / cr√©ation de partie Supabase ici
            // Pour l‚Äôinstant : ADN simple
            console.log("players= ", players);
            startAdn.players = players; // Config pour buildMinimalAdn
            partie.adn = buildMinimalAdn(startAdn);
            partie.history = []; // Reset history pour nouvelle partie
            //push partie 
            console.log("partie = ", partie, " exAdn= ", exAdn);
            console.log("adn= ", partie.adn, " startAdn= ", startAdn);

            // Joueur local = premier humain
            const human = players.find(p => p.type === 'Humain');
            user1is = human?.key || 'J1';

            closeNewPartieModal(); // Fermer modal au lieu de start-overlay

            init(); // ton init existant
        }
        function buildMinimalAdn(startAdn) {
            const j1 = startAdn.players.find(p => p.key === 'J1') || {};
            const j2 = startAdn.players.find(p => p.key === 'J2') || {};
            const j3 = startAdn.players.find(p => p.key === 'J3') || {};
            return {
                lieu: startAdn.lieu || "", // Si theme ajout√© plus tard
                sallePublic: startAdn.sallePublic,
                players: {
                    J1: {
                        sallePerso: "",
                        scene: "",
                        nom: j1.nom || "",
                        role: "",
                        perso: j1.perso || "",
                        vivant: true,
                        type: j1.type || "Humain"
                    },
                    J2: {
                        sallePerso: "",
                        scene: "",
                        nom: j2.nom || "",
                        role: "",
                        perso: j2.perso || "",
                        vivant: true,
                        type: j2.type || "gpt"
                    },
                    J3: {
                        sallePerso: "",
                        scene: "",
                        nom: j3.nom || "",
                        role: "",
                        perso: j3.perso || "",
                        vivant: true,
                        type: j3.type || "gpt"
                    }
                },
                currentSalle: "SallePublic",
                buzzActive: false
            };
        }
    </script>
    <div id="sidebar">
        <h2>Tableau de bord</h2>
        <div id="player-buttons">
            <button id="btn-j1">J1</button>
            <button id="btn-j2">J2</button>
            <button id="btn-j3">J3</button>
        </div>
        <div id="player-presentation"></div>
        <div id="player-params">
            <h3 id="params-title"></h3>
            <label>Nom: <input type="text" id="param-name"></label>
            <label>Role: <input type="text" id="param-role" readonly></label>
            <label>Personnage: <input type="text" id="param-perso"></label>
            <label>Type:
                <select id="param-type">
                    <option value="Humain">Humain</option>
                    <option value="Gpt">Gpt</option>
                </select>
            </label>
            <label>Sc√®ne: <input type="text" id="param-scene"></label>
            <label>Vivant: <input type="checkbox" id="param-vivant"></label>
            <button id="save-params">Sauvegarder</button>
        </div>
        <script>
            const playerParams = document.getElementById('player-params');
            const paramName = document.getElementById('param-name');
            const paramRole = document.getElementById('param-role');
            const paramPerso = document.getElementById('param-perso');
            const paramType = document.getElementById('param-type');
            const paramScene = document.getElementById('param-scene');
            const paramVivant = document.getElementById('param-vivant');
            const saveParams = document.getElementById('save-params');
            // Charger les params du joueur
            function loadPlayerParams(playerKey = user1is) {
                const player = partie.adn[playerKey];
                if (!player || typeof player !== 'object') return;

                paramName.value = player.nom;
                paramRole.value = player.role;
                paramPerso.value = player.perso;
                paramType.value = player.type;
                paramScene.value = player.scene;
                paramVivant.checked = player.vivant;
            }
        </script>
    </div>

    <div id="main">
        <h1>Tralala - Jeu Garou Mortel</h1>
        <div id="game-banner">
            <span id="game-status">üïØÔ∏è Le jeu est en cours</span>
            <button id="toggle-mj">Mode : Joueur</button>
            <div id="room-header">
                <div id="room-title"></div>
                <div id="room-dots">
                </div>
            </div>
            <div id="mj-panel" style="display:none;">
                <h3>üé≠ Mode Ma√Ætre du Jeu</h3>
                <textarea style="width: 300px;" id="adn-editor" rows="8"></textarea>
                <button id="apply-adn">Appliquer ADN</button>
                <button id="toggle-user">Vue : J1</button>
            </div>
        </div>
        <script>
            //////////// Btn MJ  ////////////////////////
            let mode = 'joueur'; // ou 'mj'
            const toggleMJBtn = document.getElementById('toggle-mj');
            const mjPanel = document.getElementById('mj-panel');
            const adnEditor = document.getElementById('adn-editor');
            toggleMJBtn.addEventListener('click', () => {
                if (mode === 'joueur') {
                    mode = 'mj';
                    toggleMJBtn.textContent = "Mode: MJ";
                    mjPanel.style.display = 'block';
                    adnEditor.value = JSON.stringify(partie.adn, null, 2);// Affiche ADN
                } else {
                    mode = 'joueur';
                    toggleMJBtn.textContent = "Mode: Joueur";
                    mjPanel.style.display = 'none';
                    //ViewedPlayer = 'J1';
                    loadPlayerParams();

                }
                //applyPermissions();
            });
            document.getElementById('apply-adn').addEventListener('click', () => {
                const origin = mode === 'mj' ? 'MJ' : /*ViewedPlayer*/console.log("Apply Viewed");
                applyAdnChange(origin);
            });
            function applyAdnChange(origin = 'MJ') {
                console.log("origin= ", origin);
                try {
                    const parsedAdn = JSON.parse(adnEditor.value);
                    partie.adn = parsedAdn;

                    partie.history.push({
                        sender: 'System',
                        message:
                            origin === 'MJ'
                                ? 'üîÑ L‚ÄôADN du sc√©nario a √©t√© modifi√© par le MJ.'
                                : `‚úèÔ∏è ${partie.adn[origin]?.nom ?? origin} a modifi√© ses param√®tres.`,
                        target: null
                    });
                    updateCardPlayer(); showMessages();
                    updateSalle(); // Ajout√© pour rafra√Æchir les dots apr√®s modification ADN
                } catch (e) {
                    alert("ADN invalide (JSON incorrect)");
                }
            }
        </script>
        <div id="room-info"></div>
        <!--A FAIRE : Mettre titre √† gauche et Bouton MJ/Joueur √† droite dans m√™me div-->

        <div id="display"></div>
        <div id="buzz-zone">
            <button id="buzz">BUZZ</button>
            <p id="buzz-info">Le buzz est inactif.</p>
            <button id="buzz-next">NEXT</button>
        </div>
        <div id="input-zone">
            <input type="text" id="message-input" placeholder="√âcris ton message...">
            <button id="send-btn">Envoyer</button>
        </div>
        <div>
        </div>
    </div>

    <footer>
        Jeu de r√¥le exp√©rimental par MattMarket Digitals.
        <button id="abandon-btn">Abandonner la partie</button>
        <button id="save-partie">üíæ Sauvegarder la partie</button>
    </footer>
    <script>
        // Objet Partie contenant ADN et historique
        let partie = {
            adn: {
                lieu: "√âmission TV ¬´ Tralala ¬ª",
                sallePublic: "Pupitre TV",
                players: {
                    J1: { sallePerso: 1, scene: "Epreuve", nom: "Toi", role: "Justicier", perso: "Animateur", vivant: true, type: "Humain" },
                    J2: { sallePerso: 2, scene: "Loge", nom: "Robert", role: "Acolyte", perso: "Candidat", vivant: true, type: "gpt" },
                    J3: { sallePerso: 3, scene: "Coulisses", nom: "Michel", role: "Meurtrier", perso: "Producteur", vivant: true, type: "gpt" }
                },
                currentSalle: "sallePublic",
                buzzActive: false
            },
            history: [] // {sender: 'salleKey', message: 'texte', target: 'salleKey'}
        };

        document.getElementById('abandon-btn').addEventListener('click', //async () => { await abandonnerPartie(partie.adn.J1.nom); }
            () => openNewPartieModal());
        // Initialisation
        function init() {
            const welcome = "üé¨ Bienvenue dans Tralala. Tu es l‚ÄôAnimateur (Justicier). S√©lectionne une salle ou reste en public.";
            partie.history.push({ sender: 'System', message: welcome, target: null });
            //   showMessages();
            loadPlayerParams();
            // updateCardPlayerButtons();
            //updateCardPlayer();
            //applyPermissions();
            //updateRoomInfo();
            //updateSalle(); // Ajout√© pour g√©n√©rer les dots au d√©marrage
            //setTimeout(activateBuzz, 5000);
        }
    </script>
</body>

</html>